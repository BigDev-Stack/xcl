cmake_minimum_required(VERSION 3.15)

project(xcl C CXX)

set(LIBRARY_OUTPUT_PATH ${CMAKE_CURRENT_LIST_DIR}/lib)
set(EXECUTABLE_OUTPUT_PATH ${CMAKE_CURRENT_LIST_DIR}/bin)

set(CMAKE_CXX_STANDARD 11)
set(CMAKE_C_STANDARD 11)

set(CMAKE_DEBUG_POSTFIX "d")
set(xcl_lib_name xcl)

set(CMAKE_SHARED_LIBRARY_PREFIX lib)
#set(CMAKE_SHARED_LIBRARY_SUFFIX "")
set(CMAKE_STATIC_LIBRARY_PREFIX lib)
#set(CMAKE_STATIC_LIBRARY_SUFFIX  "")

if (NOT DEFINED CMAKE_BUILD_TYPE)
    message(WARNING "cmake build type is not specified, auto set to Debug")
    set(CMAKE_BUILD_TYPE "Debug")
endif ()

set(compile_static_lib false)

set(CMAKE_C_FLAGS "-Wall -std=c11")
set(CMAKE_CXX_FLAGS "-Wall -std=c++11")

if (CMAKE_BUILD_TYPE STREQUAL "Debug")
    message(STATUS "Debug")
    set(CMAKE_C_FLAGS "-g ${CMAKE_C_FLAGS}")
    set(CMAKE_CXX_FLAGS "-g ${CMAKE_CXX_FLAGS}")
elseif (CMAKE_BUILD_TYPE STREQUAL "Release")
    message(STATUS "Release")
    set(CMAKE_C_FLAGS "-O2 ${CMAKE_C_FLAGS}")
    set(CMAKE_CXX_FLAGS "-O2 ${CMAKE_CXX_FLAGS}")
endif ()

if (${CMAKE_C_COMPILER_ID} STREQUAL "GNU" OR ${CMAKE_C_COMPILER_ID} STREQUAL "Clang")
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fvisibility=hidden")
endif ()
if (${CMAKE_CXX_COMPILER_ID} STREQUAL "GNU" OR ${CMAKE_CXX_COMPILER_ID} STREQUAL "Clang")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fvisibility=hidden")
endif ()

message(STATUS "C FLAGS:${CMAKE_C_FLAGS}")
message(STATUS "CXX FLAGS:${CMAKE_CXX_FLAGS}")

set(xcl_inc_dir include internal/inc)
set(xcl_lib_dir ${LIBRARY_OUTPUT_PATH})
include_directories(${xcl_inc_dir})

set(lib_src_files)
set(exclude_dirs)

message(STATUS ${CMAKE_SYSTEM_NAME})

if (CMAKE_SYSTEM_NAME STREQUAL "Windows")
    list(APPEND exclude_dirs macosx linux)
elseif (CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    list(APPEND exclude_dirs windows linux)
elseif (CMAKE_SYSTEM_NAME STREQUAL "Linux")
    list(APPEND exclude_dirs windows macosx)
else ()
    message(FATAL "unsupported platforms")
endif ()

function(collect_source_files source_dir)
    if (NOT IS_DIRECTORY ${source_dir})
        message(SEND_ERROR "not directory")
        return()
    endif ()
    get_filename_component(source_dir_name ${source_dir} NAME)
    set(accept true)
    foreach (exclude ${exclude_dirs})
        if (${exclude} STREQUAL ${source_dir_name})
            set(accept false)
            break()
        endif ()
    endforeach ()
    if (NOT ${accept})
        message(WARNING "ignore path ${source_dir}")
    else ()
        file(GLOB current_files ${source_dir}/*)
        foreach (path ${current_files})
            if (NOT IS_DIRECTORY ${path})
                list(APPEND lib_src_files ${path})
            else ()
                collect_source_files(${path})
            endif ()
        endforeach ()
        set(lib_src_files ${lib_src_files} PARENT_SCOPE)
    endif ()
endfunction()

collect_source_files(${CMAKE_CURRENT_LIST_DIR}/src)
collect_source_files(${CMAKE_CURRENT_LIST_DIR}/internal/src)

foreach (source_file ${lib_src_files})
    message(STATUS ${source_file})
endforeach ()

if (compile_static_lib)
    message(STATUS "static")
    add_definitions(-DSTATIC)
    add_library(${xcl_lib_name} STATIC ${lib_src_files})
else ()
    message(STATUS "dynamic")
    add_definitions(-DDYNAMIC)
    add_library(${xcl_lib_name} SHARED ${lib_src_files})
endif ()

if (CMAKE_SYSTEM_NAME STREQUAL "Windows")
    message(STATUS "windows")
    add_compile_definitions(_WIN32_WINNT=0x0A00)
    target_link_libraries(${xcl_lib_name} winmm)
else ()
    if (CMAKE_SYSTEM_NAME STREQUAL "Darwin")
        message(STATUS "macos")
    elseif (CMAKE_SYSTEM_NAME STREQUAL "Linux")
        message(STATUS "linux")
    endif ()
endif ()

if (BUILD_TEST)
    message(STATUS "building unit test")
    add_subdirectory(UnitTest)
    if (NOT compile_static_lib)
        add_custom_command(TARGET ${xcl_lib_name} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:${xcl_lib_name}> ${EXECUTABLE_OUTPUT_PATH}
                COMMAND ${CMAKE_COMMAND} -E echo "copy $<TARGET_FILE:${xcl_lib_name}> to ${EXECUTABLE_OUTPUT_PATH}"
                VERBATIM)
    endif ()
endif ()
